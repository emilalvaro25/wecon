# Supabase Database Setup for Kithai AI

To get the Kithai AI application running, you need to set up the necessary tables in your Supabase database. This guide provides the SQL script to create the tables for user profiles, conversations, and conversation turns, as well as the required security policies.

## Instructions

1.  **Navigate to your Supabase Project:** Open your Supabase project dashboard.
2.  **Go to the SQL Editor:** In the left-hand navigation menu, find and click on **SQL Editor**.
3.  **Create a New Query:** Click on the **+ New query** button.
4.  **Copy and Paste the SQL:** Copy the entire SQL script below and paste it into the query editor.
5.  **Run the Script:** Click the **Run** button.

This will create all the required tables and security policies for the application to function correctly.

---

## SQL Script

```sql
-- 1. Create profiles table to store user settings
-- This table will hold user-specific configurations like the system prompt and selected voice.
create table public.profiles (
  user_id uuid not null references auth.users on delete cascade,
  system_prompt text,
  voice text,
  primary key (user_id)
);

-- 2. Set up Row Level Security (RLS) for profiles
-- These policies ensure that users can only access and manage their own profile data.
alter table public.profiles enable row level security;

create policy "Users can view their own profile."
  on public.profiles for select
  using ( auth.uid() = user_id );

create policy "Users can insert their own profile."
  on public.profiles for insert
  with check ( auth.uid() = user_id );

create policy "Users can update their own profile."
  on public.profiles for update
  using ( auth.uid() = user_id );


-- 3. Create conversations table
-- This table stores a record for each conversation session.
create table public.conversations (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users on delete cascade,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Set up RLS for conversations
-- These policies ensure that users can only access their own conversations.
alter table public.conversations enable row level security;

create policy "Users can view their own conversations."
  on public.conversations for select
  using ( auth.uid() = user_id );

create policy "Users can insert their own conversations."
  on public.conversations for insert
  with check ( auth.uid() = user_id );


-- 5. Create turns table for conversation history
-- This table stores individual messages (turns) from both the user and the agent for each conversation.
create table public.turns (
  id bigint generated by default as identity primary key,
  conversation_id uuid not null references public.conversations on delete cascade,
  actor text not null, -- 'user' or 'agent'
  content text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. Set up RLS for turns
-- These policies ensure users can only access turns belonging to their own conversations.
alter table public.turns enable row level security;

create policy "Users can view turns from their own conversations."
  on public.turns for select
  using ( (select user_id from public.conversations where id = conversation_id) = auth.uid() );

create policy "Users can insert turns into their own conversations."
  on public.turns for insert
  with check ( (select user_id from public.conversations where id = conversation_id) = auth.uid() );
```
